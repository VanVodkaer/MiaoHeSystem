# 数据表结构说明文档

---

## 1. 用户信息表（**users**）

### 描述

存储用户的基本信息，包括微信OpenID、昵称、头像、联系方式等。

### 字段

| 字段名             | 数据类型           | 为空 | 默认值                      | 说明                               |
| ---------------- | ---------------- | --- | ------------------------- | -------------------------------- |
| **user_id**      | BIGINT UNSIGNED  | 否   | AUTO_INCREMENT            | 主键，自增用户ID                      |
| **openid**       | VARCHAR(64)      | 是   | NULL                      | 微信用户OpenID，唯一                   |
| **nickname**     | VARCHAR(50)      | 否   |                           | 用户昵称                             |
| **avatar_url**   | VARCHAR(255)     | 是   | NULL                      | 用户头像URL                          |
| **gender**       | TINYINT          | 是   | NULL                      | 性别 (1=男, 2=女, 0=未知)              |
| **phone**        | VARCHAR(20)      | 是   | NULL                      | 联系电话，唯一                         |
| **email**        | VARCHAR(100)     | 是   | NULL                      | 电子邮箱，唯一                         |
| **password**     | VARCHAR(255)     | 否   |                           | 用户密码                             |
| **permission_level** | TINYINT      | 否   | 0                         | 权限等级 (0=普通用户, 1=管理员)            |
| **created_at**   | TIMESTAMP        | 是   | CURRENT_TIMESTAMP         | 创建时间                             |
| **updated_at**   | TIMESTAMP        | 是   | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 约束与索引

- **user_id** 为主键，自增。
- **openid**、**phone**、**email** 字段设置了唯一约束，防止重复。

---

## 2. 商品分类表（**product_categories**）

### 描述

存储商品的分类信息，支持多级分类。

### 字段

| 字段名            | 数据类型           | 为空 | 默认值                      | 说明                   |
| ---------------- | ---------------- | --- | ------------------------- | -------------------- |
| **category_id**  | BIGINT UNSIGNED  | 否   | AUTO_INCREMENT            | 主键，自增分类ID           |
| **name**         | VARCHAR(100)     | 否   |                           | 分类名称，唯一             |
| **description**  | TEXT             | 是   | NULL                      | 分类描述                 |
| **parent_id**    | BIGINT UNSIGNED  | 是   | NULL                      | 父分类ID                |
| **created_at**   | TIMESTAMP        | 是   | CURRENT_TIMESTAMP         | 创建时间                 |
| **updated_at**   | TIMESTAMP        | 是   | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 约束与索引

- **category_id** 为主键，自增。
- **name** 字段设置了唯一约束。
- **parent_id** 为外键，引用自身的 **category_id**，实现多级分类，`ON DELETE SET NULL`。

---

## 3. 商品表（**products**）

### 描述

存储商品的详细信息。

### 字段

| 字段名           | 数据类型           | 为空 | 默认值                      | 说明                           |
| ---------------- | ---------------- | --- | ------------------------- | ---------------------------- |
| **product_id**   | BIGINT UNSIGNED  | 否   | AUTO_INCREMENT            | 主键，自增商品ID                  |
| **category_id**  | BIGINT UNSIGNED  | 否   |                           | 分类ID，引用商品分类表               |
| **name**         | VARCHAR(150)     | 否   |                           | 商品名称                         |
| **description**  | TEXT             | 是   | NULL                      | 商品描述                         |
| **price**        | DECIMAL(10,2)    | 否   |                           | 商品价格                         |
| **stock**        | INT UNSIGNED     | 否   | 0                         | 库存数量                         |
| **image_url**    | VARCHAR(255)     | 是   | NULL                      | 商品图片URL                      |
| **status**       | TINYINT          | 否   | 1                         | 商品状态 (1=上架, 0=下架)           |
| **created_at**   | TIMESTAMP        | 是   | CURRENT_TIMESTAMP         | 创建时间                         |
| **updated_at**   | TIMESTAMP        | 是   | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 约束与索引

- **product_id** 为主键，自增。
- **category_id** 为外键，引用 **product_categories(category_id)**，`ON DELETE CASCADE`。
- 创建了索引 **idx_products_category_id** 在 **category_id** 上，优化查询。

---

## 4. 订单表（**orders**）

### 描述

存储订单的基本信息。

### 字段

| 字段名             | 数据类型           | 为空 | 默认值                      | 说明                                                        |
| ---------------- | ---------------- | --- | ------------------------- | --------------------------------------------------------- |
| **order_id**     | VARCHAR(50)      | 否   |                           | 订单ID，由用户ID和时间戳组成                                     |
| **user_id**      | BIGINT UNSIGNED  | 否   |                           | 用户ID，引用用户信息表                                          |
| **total_amount** | DECIMAL(10,2)    | 否   |                           | 订单总金额                                                    |
| **status**       | TINYINT          | 否   | 0                         | 订单状态 (0=待支付, 1=已支付, 2=已发货, 3=已完成, 4=已取消)           |
| **payment_method** | VARCHAR(50)    | 是   | NULL                      | 支付方式                                                      |
| **payment_id**   | VARCHAR(100)     | 是   | NULL                      | 支付交易号                                                    |
| **created_at**   | TIMESTAMP        | 是   | CURRENT_TIMESTAMP         | 创建时间                                                      |
| **updated_at**   | TIMESTAMP        | 是   | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 约束与索引

- **order_id** 为主键。
- **user_id** 为外键，引用 **users(user_id)**，`ON DELETE CASCADE`。
- 创建了索引 **idx_orders_user_id** 在 **user_id** 上，优化查询。

--- 

## 5. 订单商品表（**order_items**）

### 描述

存储订单中包含的商品信息。

### 字段

| 字段名               | 数据类型           | 为空 | 默认值                      | 说明                            |
| ------------------ | ---------------- | --- | ------------------------- | ----------------------------- |
| **order_item_id**  | BIGINT UNSIGNED  | 否   | AUTO_INCREMENT            | 主键，自增订单商品ID                |
| **order_id**       | BIGINT UNSIGNED  | 否   |                           | 订单ID，引用订单表                  |
| **product_id**     | BIGINT UNSIGNED  | 否   |                           | 商品ID，引用商品表                  |
| **quantity**       | INT UNSIGNED     | 否   | 1                         | 购买数量                          |
| **unit_price**     | DECIMAL(10,2)    | 否   |                           | 商品单价                          |
| **total_price**    | DECIMAL(10,2)    | 否   |                           | 总价                              |
| **created_at**     | TIMESTAMP        | 是   | CURRENT_TIMESTAMP         | 创建时间                          |
| **updated_at**     | TIMESTAMP        | 是   | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 约束与索引

- **order_item_id** 为主键，自增。
- **order_id** 为外键，引用 **orders(order_id)**，`ON DELETE CASCADE`。
- **product_id** 为外键，引用 **products(product_id)**，`ON DELETE CASCADE`。
- 创建了索引 **idx_order_items_order_id** 在 **order_id** 上，优化查询。
- 创建了索引 **idx_order_items_product_id** 在 **product_id** 上，优化查询。

---

## 6. 会员储值卡表（**membership_cards**）

### 描述

存储会员的储值卡信息。

### 字段

| 字段名                 | 数据类型           | 为空 | 默认值                      | 说明                                    |
| -------------------- | ---------------- | --- | ------------------------- | ------------------------------------- |
| **card_id**          | BIGINT UNSIGNED  | 否   | AUTO_INCREMENT            | 主键，自增卡ID                             |
| **user_id**          | BIGINT UNSIGNED  | 否   |                           | 用户ID，唯一，引用用户信息表                  |
| **card_number**      | VARCHAR(50)      | 否   |                           | 卡号，唯一                                 |
| **balance**          | DECIMAL(10,2)    | 否   | 0.00                      | 余额                                     |
| **membership_level** | VARCHAR(50)      | 否   | 'Silver'                  | 会员等级 (Silver, Gold, Platinum, etc.) |
| **expiry_date**      | DATE             | 否   |                           | 会员卡有效期                               |
| **status**           | TINYINT          | 否   | 1                         | 卡状态 (1=有效,0=无效)                       |
| **created_at**       | TIMESTAMP        | 是   | CURRENT_TIMESTAMP         | 创建时间                                   |
| **updated_at**       | TIMESTAMP        | 是   | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 约束与索引

- **card_id** 为主键，自增。
- **user_id** 为外键，引用 **users(user_id)**，`ON DELETE CASCADE`。
- **user_id** 和 **card_number** 字段设置了唯一约束，确保每个用户只有一张会员卡，卡号唯一。
- 创建了索引 **idx_membership_cards_user_id** 在 **user_id** 上，优化查询。

---

## 7. 会员储值记录表（**membership_transactions**）

### 描述

记录会员储值卡的交易明细，如充值、消费、退款等。

### 字段

| 字段名              | 数据类型           | 为空 | 默认值              | 说明                     |
| ----------------- | ---------------- | --- | ----------------- | ---------------------- |
| **transaction_id** | BIGINT UNSIGNED  | 否   | AUTO_INCREMENT    | 主键，自增交易ID             |
| **card_id**        | BIGINT UNSIGNED  | 否   |                   | 卡ID，引用会员储值卡表         |
| **type**           | TINYINT          | 否   |                   | 交易类型 (1=充值, 2=消费, 3=退款) |
| **amount**         | DECIMAL(10,2)    | 否   |                   | 交易金额                   |
| **balance_after**  | DECIMAL(10,2)    | 否   |                   | 交易后余额                  |
| **description**    | VARCHAR(255)     | 是   | NULL              | 交易描述                   |
| **created_at**     | TIMESTAMP        | 是   | CURRENT_TIMESTAMP | 交易时间                   |

### 约束与索引

- **transaction_id** 为主键，自增。
- **card_id** 为外键，引用 **membership_cards(card_id)**，`ON DELETE CASCADE`。
- 创建了索引 **idx_membership_transactions_card_id** 在 **card_id** 上，优化查询。

---

## 8. 索引优化

为提高查询效率，添加了以下索引：

- **products** 表：在 **category_id** 上创建索引 **idx_products_category_id**。
- **orders** 表：在 **user_id** 上创建索引 **idx_orders_user_id**。
- **order_items** 表：在 **order_id** 和 **product_id** 上分别创建索引 **idx_order_items_order_id** 和 **idx_order_items_product_id**。
- **membership_cards** 表：在 **user_id** 上创建索引 **idx_membership_cards_user_id**。
- **membership_transactions** 表：在 **card_id** 上创建索引 **idx_membership_transactions_card_id**。

---

## 表之间的关系

- **users** 与 **membership_cards**：一对一关系，一个用户对应一张会员卡。
- **users** 与 **orders**：一对多关系，一个用户可以有多个订单。
- **product_categories** 与 **products**：一对多关系，一个分类下有多个商品。
- **products** 与 **order_items**：多对多关系，通过 **order_items** 表关联。
- **orders** 与 **order_items**：一对多关系，一个订单包含多个商品项。
- **membership_cards** 与 **membership_transactions**：一对多关系，一张会员卡有多条交易记录。

---

## 注意事项

- **时间字段**：`created_at` 和 `updated_at` 默认使用当前时间，并在更新时自动更新。
- **外键约束**：设置了 `ON DELETE CASCADE` 或 `ON DELETE SET NULL`，删除记录时需谨慎，避免误删关联数据。
- **字符集**：所有表的字符集为 `utf8mb4`，支持更多字符（如表情符号）。
- **金额字段**：金额相关字段采用 `DECIMAL(10,2)` 类型，确保精度。
